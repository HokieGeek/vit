#!/bin/bash

while (( $# > 0 )); do
    case $1 in
    blame|log) vimargs+=('-c' 'Git '$1) ;;
    -h|--help) echo "USAGE: ${0##*/} [-h|--help] [blame|log] [file]"; exit ;;
    k) ;; ## standalone :)
    *) args+=("$1") ;;
    esac
    shift
done

if (( ${#vimargs[*]} == 0 )); then
    vimargs+=('--cmd' 'let g:vit_standalone=1')
    vimargs+=('-c' 'Git log')
    vimargs+=('-c' 'Git status')
    vimargs+=('-c' 'wincmd t')
    (( ${#args[*]} == 0 )) && vimargs+=('--cmd' 'cd '$PWD)
fi

(( ${#args[*]} > 0 )) && {
    origdir=$PWD
    filedir=${1%/*}
    cd ${filedir:-$PWD}
}

git rev-parse --is-inside-work-tree >/dev/null 2>&1 || {
    echo "Could not find a git working tree" >&2
    exit 1
}

[[ -z ${origdir+x} ]] && cd ${origdir}

me=${0##*/}
exec ${me/vit/}vim "${args[@]}" "${vimargs[@]}"
